{% if table_error %}
{% set title = "Unable to load item summary" %}
{% set message = table_error %}
{% include "components/error_state.html" %}
{% endif %}


{% if table %}
{% set summary = table %}
<div class="space-y-6" data-testid="item-summary" data-filter-root data-current-search="{{ table.filters.search }}"
    data-current-slot="{{ table.filters.slot or '' }}" data-page-size="{{ table.pagination.page_size }}">
    <header class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
        <div class="space-y-1">
            <h2 class="text-2xl font-semibold">Item Usage Overview</h2>
            <p class="text-sm opacity-80">
                {{ table.total_items }} items tracked Â· {{ table.used_total }} used.
            </p>
        </div>
        <div class="flex flex-wrap gap-2 text-xs">
            <span class="badge badge-success badge-outline">Used ({{ table.used_total }})</span>
        </div>
    </header>

    {% include "components/filter_controls.html" %}


    <section class="space-y-3" data-filter-section>
        <div class="overflow-x-auto rounded-lg border border-base-300/80" data-filter-list>
            <table class="table table-zebra w-full">
                <thead>
                    <tr class="text-sm uppercase tracking-wide text-base-content/70">
                        <th class="w-1/3">Item</th>
                        <th class="w-1/5">Slot</th>
                        <th class="w-1/3">Usage</th>
                        <th class="w-1/6 text-right">Variants</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in table.rows %}
                    <tr data-filter-item data-item-id="{{ row.item_id }}" data-item-name="{{ row.name }}"
                        data-item-slot="{{ (row.slot or 'Unknown')|lower }}">
                        <td class="align-top">
                            <div class="flex flex-col">
                                <span class="font-medium">{{ row.name }}</span>
                                <span class="text-xs text-base-content/60">{{ row.item_id }}</span>
                            </div>
                        </td>
                        <td class="align-top text-sm">
                            {{ row.slot or "Unknown" }}
                        </td>
                        <td class="align-top">
                            <div class="flex flex-col gap-1">
                                <span class="badge {{ row.badge_class }} badge-sm w-fit">Used</span>
                                <span class="text-xs text-base-content/70">{{ row.usage_label }}</span>
                            </div>
                        </td>
                        <td class="align-top text-right text-sm">
                            {% if row.variant_ids %}
                            {{ row.variant_ids | length }}
                            {% else %}
                            &mdash;
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p class="rounded-lg border border-dashed border-base-300 bg-base-100/60 p-6 text-sm" data-filter-empty
            data-empty-default="Apply your selections to view item usage."
            data-empty-filtered="No items match your current filters. Try clearing the search or slot filter." {% if
            table.rows %}hidden{% endif %}>
            Apply your selections to view item usage.
        </p>
    </section>
</div>
{% else %}
{% set title = "No selection applied" %}
{% set message = "Choose classes and builds, then click Apply filter to generate the item usage table." %}
{% include "components/empty_state.html" %}
{% endif %}
